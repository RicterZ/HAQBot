# HAQBot

[English](README.md) | [ä¸­æ–‡](README_CN.md)

é€šè¿‡è‡ªç„¶è¯­è¨€å¯¹è¯æ§åˆ¶ Home Assistant è®¾å¤‡çš„ QQ æœºå™¨äººã€‚

## åŠŸèƒ½ç‰¹æ€§

- **è‡ªç„¶è¯­è¨€æ§åˆ¶**ï¼šåœ¨ QQ ç¾¤ä¸­é€šè¿‡æ–‡æœ¬æˆ–è¯­éŸ³æ¶ˆæ¯æ§åˆ¶ Home Assistant è®¾å¤‡
- **ç›´æ¥å‘½ä»¤æ§åˆ¶**ï¼šé€šè¿‡å‘½ä»¤ï¼ˆ`/turnon`ã€`/turnoff`ã€`/toggle`ï¼‰å¿«é€Ÿæ§åˆ¶è®¾å¤‡ï¼Œæ— éœ€ LLM å¤„ç†
- **å®ä½“æŸ¥æ‰¾**ï¼šæ”¯æŒé€šè¿‡å®ä½“ IDã€å‹å¥½åç§°æˆ–åˆ«åæ§åˆ¶è®¾å¤‡
- **è®¾å¤‡ä¿¡æ¯æŸ¥è¯¢**ï¼šæŸ¥è¯¢è®¾å¤‡çŠ¶æ€å¹¶æŒ‰ç±»å‹åˆ—å‡ºè®¾å¤‡ï¼ˆ`/info`ã€`/light`ã€`/switch`ï¼‰
- **åŒºåŸŸåˆ†ç»„**ï¼šè®¾å¤‡æŒ‰åŒºåŸŸåˆ†ç»„æ˜¾ç¤ºï¼Œä¾¿äºç®¡ç†
- **å®ä½“ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜å®ç°å¿«é€Ÿå®ä½“æŸ¥æ‰¾ï¼Œé¿å…é‡å¤ API è°ƒç”¨
- **æƒé™æ§åˆ¶**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é™åˆ¶ç‰¹å®š QQ ç”¨æˆ·æ§åˆ¶è®¾å¤‡
- **è¯­éŸ³è¯†åˆ«**ï¼šä½¿ç”¨è…¾è®¯äº‘ ASR API è‡ªåŠ¨è½¬å½•éŸ³é¢‘æ¶ˆæ¯
- **å¯¹è¯ä¸Šä¸‹æ–‡**ï¼šä¸ºæ¯ä¸ªç¾¤ç»„ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè‡ªç„¶å¯¹è¯
- **Webhook é€šçŸ¥**ï¼šHome Assistant å¯ä¸»åŠ¨å‘ QQ ç¾¤å‘é€é€šçŸ¥
- **å¤šæ¨¡æ€æ”¯æŒ**ï¼šæ”¯æŒå‘é€æ–‡æœ¬æ¶ˆæ¯åŠæ–‡ä»¶æˆ–è§†é¢‘æµ
- **å¼‚æ­¥å¤„ç†**ï¼šéé˜»å¡æ¶ˆæ¯å¤„ç†ï¼Œæå‡æ€§èƒ½
- **å›½é™…åŒ–æ”¯æŒ**ï¼šæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡

## æ¶æ„è¯´æ˜

### æ–‡æœ¬æ¶ˆæ¯æµç¨‹
```
QQ æ¶ˆæ¯ â†’ NapCat WebSocket â†’ æœºå™¨äºº â†’ HA å¯¹è¯ API â†’ Ollama ä»£ç† â†’ è®¾å¤‡æ§åˆ¶ â†’ å“åº”
```

### è¯­éŸ³æ¶ˆæ¯æµç¨‹
```
QQ è¯­éŸ³ â†’ NapCat â†’ ä¸‹è½½éŸ³é¢‘ â†’ è…¾è®¯ ASR â†’ æ–‡æœ¬ â†’ HA å¯¹è¯ API â†’ å“åº”
```

## é…ç½®

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `.env.default`ï¼‰ï¼š

```env
# NapCat WebSocket è¿æ¥åœ°å€
NAPCAT_API=ws://napcat:3001

# Home Assistant é…ç½®
HA_URL=http://homeassistant:8123
HA_TOKEN=ä½ çš„é•¿æœŸè®¿é—®ä»¤ç‰Œ
HA_AGENT_ID=conversant.ollama_conversation

# è…¾è®¯äº‘ ASRï¼ˆç”¨äºè¯­éŸ³è¯†åˆ«ï¼‰
TENCENT_SECRET_ID=ä½ çš„è…¾è®¯äº‘å¯†é’¥ID
TENCENT_SECRET_KEY=ä½ çš„è…¾è®¯äº‘å¯†é’¥
TENCENT_ASR_ENGINE=16k_zh  # å¯é€‰ï¼Œé»˜è®¤ï¼š16k_zh
TENCENT_ASR_REGION=         # å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤

# QQ è´¦å·ï¼ˆå¿…éœ€ï¼‰- æœºå™¨äººçš„ QQ å·
ACCOUNT=your_qq_account_number

# æƒé™æ§åˆ¶ï¼ˆå¯é€‰ï¼‰
# å…è®¸æ§åˆ¶è®¾å¤‡çš„ QQ å·ç ï¼Œç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”
# å¦‚æœä¸ºç©ºï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥æ§åˆ¶è®¾å¤‡
ALLOWED_SENDERS=123456789 987654321

# è¯­è¨€è®¾ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šzh_CNï¼‰
# é€‰é¡¹ï¼šzh_CNï¼ˆä¸­æ–‡ï¼‰ï¼Œen_USï¼ˆè‹±æ–‡ï¼‰
LANGUAGE=zh_CN

# è°ƒè¯•æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šfalseï¼‰
# è®¾ç½®ä¸º true ä»¥å¯ç”¨è°ƒè¯•æ—¥å¿—
DEBUG=false

# Webhook é…ç½®ï¼ˆå¯é€‰ï¼‰
WEBHOOK_PORT=8080
WEBHOOK_TOKEN=ä½ çš„webhookä»¤ç‰Œ
```

### é…ç½®æŒ‡å—

#### Home Assistant ä»¤ç‰Œ

1. ç™»å½• Home Assistant
2. è¿›å…¥ ä¸ªäººèµ„æ–™ â†’ é•¿æœŸè®¿é—®ä»¤ç‰Œ
3. åˆ›å»ºæ–°ä»¤ç‰Œå¹¶å¤åˆ¶åˆ° `HA_TOKEN`

#### å¯¹è¯ä»£ç†

ç¡®ä¿åœ¨ Home Assistant ä¸­é…ç½®äº† `conversant.ollama_conversation` å¯¹è¯ä»£ç†ã€‚

#### è…¾è®¯äº‘ ASRï¼ˆå¯é€‰ï¼‰

1. ç™»å½• [è…¾è®¯äº‘æ§åˆ¶å°](https://console.cloud.tencent.com/)
2. è¿›å…¥ **è®¿é—®ç®¡ç†** â†’ **API å¯†é’¥ç®¡ç†**
3. åˆ›å»ºæ–° API å¯†é’¥å¹¶å¤åˆ¶ `SecretId` å’Œ `SecretKey`
4. å¯ç”¨ **è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰** æœåŠ¡

> **æ³¨æ„**ï¼šè¯­éŸ³è¯†åˆ«ä¸ºå¯é€‰åŠŸèƒ½ã€‚æœªé…ç½® ASR å‡­è¯æ—¶ï¼Œæœºå™¨äººä»…å¤„ç†æ–‡æœ¬æ¶ˆæ¯ã€‚

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- å·²é…ç½®å¯¹è¯ä»£ç†ï¼ˆOllamaï¼‰çš„ Home Assistant
- NapCat QQ æœºå™¨äººæ¡†æ¶
- ï¼ˆå¯é€‰ï¼‰è…¾è®¯äº‘ ASR å‡­è¯ï¼Œç”¨äºè¯­éŸ³è¯†åˆ«

### å®‰è£…

1. å…‹éš†æ­¤ä»“åº“
2. å¤åˆ¶ `.env.default` åˆ° `.env` å¹¶é…ç½®ä½ çš„è®¾ç½®
3. ä½¿ç”¨ Docker Compose è¿è¡Œï¼š

```bash
docker-compose up -d
```

æˆ–ç›´æ¥è¿è¡Œï¼š

```bash
poetry install
poetry run python src/maid/main.py
```

## ä½¿ç”¨æ–¹æ³•

### è‡ªç„¶è¯­è¨€æ§åˆ¶

åªéœ€åœ¨ QQ ç¾¤ä¸­å‘é€æ¶ˆæ¯ï¼ˆæ— éœ€å‘½ä»¤å‰ç¼€æˆ– @ï¼‰ã€‚æœºå™¨äººå°†ï¼š
1. å°†æ¶ˆæ¯è½¬å‘åˆ° Home Assistant çš„å¯¹è¯ä»£ç†
2. å¤„ç†å¹¶æ‰§è¡Œè®¾å¤‡æ§åˆ¶å‘½ä»¤
3. è¿”å›æ‰§è¡Œç»“æœ

**ç¤ºä¾‹ï¼š**
- ç”¨æˆ·ï¼š"æ‰“å¼€å®¢å…çš„ç¯"
- æœºå™¨äººï¼š"å®¢å…çš„ç¯å·²æ‰“å¼€"

**è¯­éŸ³æ¶ˆæ¯ï¼š**
- åœ¨ç¾¤ä¸­å‘é€è¯­éŸ³æ¶ˆæ¯
- æœºå™¨äººè‡ªåŠ¨è½¬å½•å¹¶å¤„ç†
- è¿”å›å“åº”

> **æ³¨æ„**ï¼šå¦‚æœè¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œæœºå™¨äººå°†é™é»˜è·³è¿‡è¯¥æ¶ˆæ¯ä»¥é¿å…åˆ·å±ã€‚

### ç›´æ¥å‘½ä»¤

æœºå™¨äººæ”¯æŒç›´æ¥å‘½ä»¤ï¼Œæ— éœ€ LLM å¤„ç†å³å¯å¿«é€Ÿæ§åˆ¶è®¾å¤‡ï¼š

#### è®¾å¤‡æ§åˆ¶å‘½ä»¤

- `/turnon <entity_id> [<entity_id2> ...]` - æ‰“å¼€è®¾å¤‡
  - æ”¯æŒå®ä½“ IDï¼ˆå¦‚ `light.living_room`ï¼‰ã€å‹å¥½åç§°æˆ–åˆ«å
  - å¯åŒæ—¶æ§åˆ¶å¤šä¸ªè®¾å¤‡
  - ç¤ºä¾‹ï¼š`/turnon å®¢å…ç¯` æˆ– `/turnon light.living_room light.bedroom`

- `/turnoff <entity_id> [<entity_id2> ...]` - å…³é—­è®¾å¤‡
  - ä¸ `/turnon` ç›¸åŒï¼Œä½†ç”¨äºå…³é—­è®¾å¤‡

- `/toggle <entity_id> [<entity_id2> ...]` - åˆ‡æ¢è®¾å¤‡çŠ¶æ€
  - åˆ‡æ¢æŒ‡å®šè®¾å¤‡çš„çŠ¶æ€

#### ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤

- `/info` - è·å– Home Assistant ç¯å¢ƒä¿¡æ¯
  - æŒ‰ç±»å‹æ˜¾ç¤ºå®ä½“ç»Ÿè®¡ï¼ˆä¼ æ„Ÿå™¨ã€å¼€å…³ã€ç¯å…‰ç­‰ï¼‰
  - æ˜¾ç¤ºé‡è¦ä¼ æ„Ÿå™¨çš„å½“å‰çŠ¶æ€

- `/light` - åˆ—å‡ºæ‰€æœ‰ç¯å…‰è®¾å¤‡
  - æŒ‰åŒºåŸŸåˆ†ç»„è®¾å¤‡
  - æ˜¾ç¤ºå‹å¥½åç§°ã€å®ä½“ ID å’Œå½“å‰çŠ¶æ€

- `/switch` - åˆ—å‡ºæ‰€æœ‰å¼€å…³è®¾å¤‡
  - ä¸ `/light` ç›¸åŒï¼Œä½†ç”¨äºå¼€å…³è®¾å¤‡

- `/help` - æ˜¾ç¤ºæ‰€æœ‰æ”¯æŒçš„å‘½ä»¤å’Œæè¿°

#### å‘½ä»¤ç‰¹æ€§

- **å®ä½“æŸ¥æ‰¾**ï¼šå‘½ä»¤æ”¯æŒä¸‰ç§æ–¹å¼è¯†åˆ«è®¾å¤‡ï¼š
  1. å®ä½“ IDï¼š`light.living_room`
  2. å‹å¥½åç§°ï¼š`å®¢å…ç¯`
  3. åˆ«åï¼šHome Assistant ä¸­é…ç½®çš„ä»»ä½•åˆ«å

- **å¤šè®¾å¤‡æ§åˆ¶**ï¼šåœ¨ä¸€ä¸ªå‘½ä»¤ä¸­é€šè¿‡ç©ºæ ¼åˆ†éš”æ§åˆ¶å¤šä¸ªè®¾å¤‡

- **æƒé™æ§åˆ¶**ï¼šå¦‚æœè®¾ç½®äº† `ALLOWED_SENDERS`ï¼Œåªæœ‰æŒ‡å®šçš„ QQ ç”¨æˆ·å¯ä»¥ä½¿ç”¨æ§åˆ¶å‘½ä»¤ï¼ˆ`/turnon`ã€`/turnoff`ã€`/toggle`ï¼‰ã€‚ä¿¡æ¯å‘½ä»¤ï¼ˆ`/info`ã€`/light`ã€`/switch`ã€`/help`ï¼‰å¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾ã€‚

- **é‡å¤åˆ«åè­¦å‘Š**ï¼šå¦‚æœå¤šä¸ªå®ä½“å…±äº«ç›¸åŒçš„åˆ«åï¼Œæœºå™¨äººä¼šè­¦å‘Šä½ ï¼Œä½†ä»ä¼šæ§åˆ¶ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹


## Webhook API

æœºå™¨äººæä¾› Webhook æ¥å£ï¼Œä¾› Home Assistant ä¸»åŠ¨å‘ QQ ç¾¤å‘é€é€šçŸ¥ã€‚

### æ–‡æœ¬é€šçŸ¥

**æ¥å£**ï¼š`POST http://homeassistant-qq:8080/webhook/notify`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "group_id": "123456789",
  "message": "ä½ çš„é€šçŸ¥æ¶ˆæ¯",
  "token": "å¯é€‰çš„webhookä»¤ç‰Œ"
}
```

**å‚æ•°**ï¼š
- `group_id`ï¼ˆå¿…éœ€ï¼‰ï¼šQQ ç¾¤å·
- `message`ï¼ˆå¿…éœ€ï¼‰ï¼šæ¶ˆæ¯æ–‡æœ¬
- `token`ï¼ˆå¯é€‰ï¼‰ï¼šè®¤è¯ä»¤ç‰Œï¼ˆå¦‚æœè®¾ç½®äº† `WEBHOOK_TOKEN`ï¼‰

### å¤šæ¨¡æ€é€šçŸ¥

**æ¥å£**ï¼š`POST http://homeassistant-qq:8080/webhook/multimodal`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "group_id": "123456789",
  "message": "å¯é€‰çš„æ–‡æœ¬æ¶ˆæ¯",
  "url": "http://example.com/video_stream.m3u8",
  "token": "å¯é€‰çš„webhookä»¤ç‰Œ",
  "duration": 60
}
```

**å‚æ•°**ï¼š
- `group_id`ï¼ˆå¿…éœ€ï¼‰ï¼šQQ ç¾¤å·
- `message`ï¼ˆå¯é€‰ï¼‰ï¼šæ¶ˆæ¯æ–‡æœ¬
- `url`ï¼ˆå¯é€‰ï¼‰ï¼šè§†é¢‘æµ URLï¼ˆæ”¯æŒ HLS/m3u8ï¼Œé€šè¿‡ ffmpeg ä¸‹è½½ï¼‰
- `token`ï¼ˆå¯é€‰ï¼‰ï¼šè®¤è¯ä»¤ç‰Œ
- `duration`ï¼ˆå¯é€‰ï¼‰ï¼šè§†é¢‘å½•åˆ¶æ—¶é•¿ï¼ˆç§’ï¼Œé»˜è®¤ï¼š60ï¼‰

> **æ³¨æ„**ï¼š`message` å’Œ `url` è‡³å°‘éœ€è¦æä¾›ä¸€ä¸ªã€‚

### Home Assistant é›†æˆ

#### é…ç½® REST å‘½ä»¤

åœ¨ `configuration.yaml` ä¸­æ·»åŠ ï¼š

```yaml
rest_command:
  homeassistant_qq:
    url: "http://homeassistant-qq:8080/webhook/notify"
    method: POST
    content_type: "application/json"
    payload: |
      {
        "group_id": "123456789",
        "message": "{{ message }}",
        "token": "{{ token | default('') }}"
      }
  
  homeassistant_qq_multimodal:
    url: "http://homeassistant-qq:8080/webhook/multimodal"
    method: POST
    content_type: "application/json"
    payload: |
      {
        "group_id": "123456789",
        "message": "{{ message }}",
        "url": "{{ video_url }}",
        "token": "{{ token | default('') }}",
        "duration": {{ duration | default(60) }}
      }
```

#### è‡ªåŠ¨åŒ–ç¤ºä¾‹

**ç®€å•é€šçŸ¥ï¼š**
```yaml
automation:
  - alias: "æ´—è¡£æœºå®Œæˆé€šçŸ¥"
    trigger:
      - platform: state
        entity_id: sensor.washing_machine_status
        to: "completed"
    action:
      - service: rest_command.homeassistant_qq
        data:
          message: "ğŸ§º æ´—è¡£æœºå·²å®Œæˆï¼"
```

**å¸¦è§†é¢‘çš„å¤šæ¨¡æ€é€šçŸ¥ï¼š**
```yaml
automation:
  - alias: "é—¨å£æœ‰äººç§»åŠ¨-å‘é€QQé€šçŸ¥"
    trigger:
      - trigger: state
        entity_id:
          - camera.front_door
        attribute: motion_video_time
        for:
          hours: 0
          minutes: 0
          seconds: 20
    action:
      - service: rest_command.homeassistant_qq_multimodal
        data:
          message: "âš ï¸ ä¾¦æµ‹åˆ°é—¨å£æœ‰äºº"
          url: "{{ state_attr('camera.front_door', 'stream_address') }}"
          duration: 30
```

### å®‰å…¨

å¦‚æœè®¾ç½®äº† `WEBHOOK_TOKEN`ï¼Œè¯·åœ¨ Webhook è¯·æ±‚çš„ `token` å­—æ®µä¸­åŒ…å«ç›¸åŒçš„ä»¤ç‰Œï¼Œä»¥é˜²æ­¢æœªæˆæƒè®¿é—®ã€‚

## å¼€å‘

### è¦æ±‚

- Python 3.10+
- Poetry
- Docker & Docker Composeï¼ˆç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼‰

### è®¾ç½®

```bash
# å®‰è£…ä¾èµ–
poetry install

# æœ¬åœ°è¿è¡Œ
poetry run python src/maid/main.py

# æˆ–ä½¿ç”¨ Docker
docker-compose up -d
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ GNU Affero é€šç”¨å…¬å…±è®¸å¯è¯ v3.0 (AGPL-3.0) è®¸å¯ã€‚

è¯¦æƒ…è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚

### é™„åŠ æ¡æ¬¾

- **å•†ä¸šä½¿ç”¨**ï¼šæœªç»ä½œè€…æ˜ç¡®è®¸å¯ï¼Œç¦æ­¢å•†ä¸šä½¿ç”¨
- **ç½²å**ï¼šæ‰€æœ‰é‡æ–°åˆ†å‘å’Œä¿®æ”¹å¿…é¡»åŒ…å«åŸä½œè€…ç½²å

